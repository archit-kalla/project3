/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */

#include "communicate.h"
#include <stdio.h>
#include <dirent.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>

//global nodelist 
// global int load
char this_peer_dir[] = {"tempname"};
FileList filelist;
// global char[120] server_type

void scan(char *dir){
	struct dirent *pDirent;
    DIR *pDir;

    pDir = opendir(this_peer_dir);
    if(pDir == NULL){
        printf("Cannot open directory %s.\n", this_peer_dir);
        return;
    }

    printf("Opened directory %s.\n", this_peer_dir);

    struct stat sb;

    int i = 0;
    while((pDirent = readdir(pDir)) != NULL){
        if(strcmp(pDirent->d_name, "..") != 0 && strcmp(pDirent->d_name, ".") != 0){
            //printf("[%s]\n", pDirent->d_name);
            file thisFile;
            strcpy(thisFile.name, pDirent->d_name);
            char filePath[256];
            strcpy(filePath, this_peer_dir);
            strcat(filePath, "/");
            strcat(filePath, pDirent->d_name);

            if(stat(filePath, &sb) == -1){
                perror("stat");
            }
            else{
                thisFile.size = (int) sb.st_size;
                filelist.files[i] = thisFile;
                i++;
            }
			if(i == 50) break;
        }
    }
	filelist.fileAmount = i;

    closedir(pDir);

    for(int j = 0; j < filelist.fileAmount; j++){
        printf("File: %s of size %d bytes.\n", filelist.files[j].name, filelist.files[j].size);
    }
    
    return;
}

// void download_thread(void *arg){
	// get the file name
	// get the peer ip and port
	// get the file from the peer
	// update the file list
	// call scan
//}

// node* peer_select(NodeList *list){
	// select a peer from the list based on load and latency
	// return the peer
// }

// void read_config(){
	//hardcoded file name/path
// }


NodeList *
find_1_svc(char *filename,  struct svc_req *rqstp)
{
	static NodeList  result;

	/*
	 * insert server code here
	 */
	//if server_type == trackingserver

	// only called by peers to trackingserver
	// return list of peers that have the file
	// for loop updatelist across all peers
	// 		update the global node list
	// return list of peers that have the file

	return &result;
}

int *
download_1_svc(char *filename,  struct svc_req *rqstp)
{
	static int  result;

	/*
	 * insert server code here
	 */

	//after download, call scan

	return &result;
}

int *
getload_1_svc(struct svc_req *rqstp)
{
	static int  result;

	/*
	 * insert server code here
	 */

	// lock the load variable
	// read it 
	// unlock it
	// return it


	return &result;
}

FileList *
updatelist_1_svc(struct svc_req *rqstp)
{
	static FileList  result;

	/*
	 * insert server code here
	 */
	//scan directory for files

	return &result;
}
